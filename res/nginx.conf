daemon {{nginx.daemon}};
pid {{nginx.pid}};
worker_processes {{nginx.workers}};
error_log {{nginx.error_log}} info;

events {}

http {

  include {{openresty_dir}}/nginx/conf/mime.types;

  access_log {{nginx.access_log}};

  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_min_length 1000;
  gzip_types text/plain text/css text/xml text/javascript application/json
    application/javascript application/xml application/wasm image/svg+xml;

  lua_package_path "{{lua_package_path}}";
  lua_package_cpath "{{lua_package_cpath}}";

  init_by_lua_file {{modules.tokuboilerplate\.web\.init}};

  server {
    listen {{nginx.port}};
    listen [::]:{{nginx.port}};
    server_name {{nginx.domain}};
    return 301 https://$host:{{nginx.ssl_port}}$request_uri;
  }

  server {

    server_name {{nginx.domain}};
    listen {{nginx.ssl_port}} ssl;
    listen [::]:{{nginx.ssl_port}} ssl;
    ssl_certificate {{nginx.ssl_cert}};
    ssl_certificate_key {{nginx.ssl_key}};
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location = / {
      limit_except GET { deny all; }
      root public;
      try_files /{{index_hashed}} =404;
      add_header Cache-Control 'private, max-age=60';
    }

    location = /sw.js {
      limit_except GET { deny all; }
      root public;
      try_files /{{sw_hashed}} =404;
      add_header Cache-Control 'private, max-age=60';
    }

    location ~* "\.[a-f0-9]{12}\." {
      limit_except GET { deny all; }
      root public;
      expires 1y;
      add_header Cache-Control "public, immutable";
    }

    location = /sync {
      limit_except POST { deny all; }
      content_by_lua_file {{modules.tokuboilerplate\.web\.sync}};
    }
  }
}
